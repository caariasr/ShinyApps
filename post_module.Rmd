---
title: "Big data post module assignment"
author: "CADMS"
date: "6/18/2017"
output:
  html_document:
    code_folding: hide
    highlight: kate
    keep_md: yes
    theme: readable
    toc: yes
    css: "width.css"
runtime: shiny
resource_files:
- bigdata.Rproj
---
<link href="test.css" rel="stylesheet">
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# source('/gridapps/hive/HIVERJARS/connect2hive.R')
```

```{r packages, include=FALSE, message=FALSE}
library(knitr)
library(shiny)
library(highr)
library(base64enc)
library(png)
library(ggvis)
library(plyr)
library(dplyr)
library(ggmap)
library(zipcode)
library(ggplot2)
library(ggthemes)
colfunc <- colorRampPalette(c("blue", "gray"))
```

##Introduction

The Big Data post-module assignment provides an opportunity to learn how to interact with hive, how to understand and clean multiple databases, how to merge the disparate data into one database, and finally how to analyze the data to draw conclusions and make correlations. This R Markdown document depicts Team CADMS' efforts to take advantage of this learning opportunity by creating an interactive narrative of the step-by-step process followed since the post-module period began. The initial steps included accessing, understanding, and cleaning the data, followed by filtering the data to merge it into a single analyzable database. The final step was to cunduct analysis and create visualizations to understand connections and correlations present in the data.

This report analyzes data from 311 Calls, restaurant violations, housing violations and population by zip code for New York City. The calls and violations data is from the year 2016 with corresponding population by zip code data from the year 2010. 

All the files are allocated in the Stern big data cluster in the Hive MSBA database. The files have the following names:

| Description                             | Table Name        |
| ----------------------------------------|:----------------- |
|311 Calls for 2016                       |NYC311calls2016    |
|Restaurant Violations (all years)        |nycrestaurants     |
|Housing Violations (all years)           |housingviolations  |
|Population by Zip code (all US for 2010)  |popbyzip2010       |

Throughout the document, the reader will find **in bold** the difficulties encountered during the process.

##Hypothesis

* There are correlations between 311 calls, housing violations, restaurants and population in New York City.

* The behavior of calls and violations changes by month of the year.

##Procedure

1. Data Understanding 
2. Data Cleaning Process
3. Data Merging Process
+ Creation of Data Views
+ Data Aggregation and Merge
4. Visualizations and Correlation analysis
5. Conclusions

## Data Understanding

This initial step in the process is for the broad and detailed understanding of every field in the database. The data is divided into four separate data tables. Each data table must be reviewed for data clarity and consistency. Below is the step-by-step approach for data understanding:

1. For every table, a data dictionary was built to describe the following for each attribute.
+ Data type
+ Description
+ Problems with the data
+ Solutions to the problems with the data
+ The type to which the variable should be converted.

The data dictionary is located at the following [link.](https://docs.google.com/spreadsheets/d/1JmR_Ltpbqzho_SWPS-0K1CfEyaVPVwluhBMAzfY7sNM/edit?usp=sharing)

### Analyzing and Understanding the Files/Tables

#### Zip codes

Zip code is the common variable accross all tables. The main issue with zip code date was the format: some zip code data points only had 4 digits, others had foreign characters like dashes or thiks. This issue was solved by removing any non-numeric characters from the zip code data and by only selecing the first 5 elements. This doesn't solve all the problems with the zip code variable (there are typos and other possible errors) but it did enough to have a good match between all tables. Finally, the zip code data was filtered in all tables to be between $10001$ and $11697$, which is the range that corresponds to New York City.

#### Restaurant Violations (all years)  - nycrestaurants

This table is composed of 19 attributes that describe the restaurant violations for the boroughs of Brooklyn, Bronx, Manhattan, Queens and Staten Island. The table contains all the attributes that identify each restaurant along with the details of the violations.

Findings:

+ 824 records have no violation code. They are the result of an inspection that concluded with: "No violations were recorded at the time of this inspection." Therefore, these records need to deleted from the data table since they do not represent any violations. 

+ 209 records do not have information in the following fields: dba (name of the restaurant), cuisine_description, inspection_date, action, violation_code, violation_description, critical_flag, score, grade, grade_date, and inspection_type. These records were also deleted.

#### Population by Zip Code (all US for 2010) - popbyzip2010

This file contains the population for all zip codes in the United States for the year 2010. Even though the analysis is for the year 2016, the population of the year 2010 is a close proxy.

Findings:

+ Only took into account zip codes that corresponded with New York City and the boroughs included in the other tables.

+ For some records the population is 0. The explanation is not that the record is wrong, it simply indicates that in that specific zip code there are no residence. Since restaurant violations are part of the data set, the decision was made to keep the zip codes of population 0 in the cleaning process and to only remove them (and also any zip code with population less than 2000) in the visualization step.  

#### Housing Violations (all years) - housingviolations

This file contains the housing violation history for the boroughs of Brooklyn, Bronx, Manhattan, Queens and Staten Island. The records clearly state when the inspection occured, the location address, the description of the violation, followed by the current status. It is worth mentioning that this file has most of the records with consistent information, and no issues were found while processing the information. 

#### 311 Calls for 2016 - NYC311calls2016

This file contains all the 311 calls received in New York City for the year 2016. The zip code that this table provides is not for the location of the call but the location of the incident. This becomes important for analyzing the correlation among all four tables. Some of the records show that there was in fact no incident or that it was not possible to perform the inspection. However, the records were kept since the focus is not only on calls but also violations for each zip code. 

Findings:

+ Among all data tables, this is the only one that provides the geo location of the reported incident. 

+ The detail for each incident is more than what is needed for analysis, so most filed that did not correlate to the other data table were discarded. This will make the data table lighter and easier to analyze.

+ For anallysis purposes, this data table was divided into two seperate tables. One consisted of housing call, the other of restaurant calls. To split this data table appropriatly, the New York City open data website was referenced.

To also include visualizations violation locations could be overlayed with maps, a method to plot observations by zip code need to be found. Even though the table nyc311calls2016 provided geo location for all calls, there was no way to match each location to the other tables, therefore another, more general way of plotting all this information in a map was needed. A simple and fast approach is to use the latitude and longitude of the center point for each zip code. This data was readily available for all US zip codes in the R package called "zipcode", and so this package was called using the command`data("zipcode")`.

**Difficulties**: 

* The first difficulty was finding a better way to clean zip code data. It was better to clean each zip code before doing the merge than to leave some of the zip codes uncleaned hopping those with problems were not going to be used. Regular expressions were used to remove any non-numerical character and then select the first five (or less if that maximum was lower than five) numeric characters. 

* Additional variables were considered for analysis, but some of them had many categories. In terms of the merging process, this would complicate the process in the sense that each category would be represented as a separated row in order to be able to be merged. Besides, the total number of zip codes would be reduced (all zip codes with no information on those variables would not show in the final table). 

* Another issue was to find a way to comfortably filter and overview the data in order to find the singularities within each field: empty values, typos, incomplete values and incorrect formats. This was solved by creating tables and views where the values were unique. After using filters and sorting tools we could easily find all problematic values.

* There were multiple complications when trying to connect to Hive in the Big Data instances. High traffic contributed to this issue because several other students were trying to access the instances at the same time. However, this is a hypothesis and is difficult to validate. In addition, the large amount of logs that were created eventually filled the quota of space available on the server. This also represented a problem when trying to install several R packages needed for the visualizations. The solution was to contact the cluster administrator (Professor White) and ask to have the packages installed and made accessible to students.

* While building the data dictionary, understanding the meaning of some of the variables was difficult. The following website was used as a source to better understind the variables: [NYC OpenData website] (https://opendata.cityofnewyork.us/).

##Data Cleaning Process

The first step of the data cleaning process was to create the team database in hive and to move the tables from the `msba` database into it.

The second step focused on cleaning the data under zip code in all three tables. Some of the zip codes had incorrect formatting, such as additional digits and symbols. The symbols were removed and the first five digits were extracted as "true" zip codes. Subsequently, the zip codes were converted to numbers and filtered to only include those in New York City (Between 10001 and 11697). 

Additional steps in the Data Cleaining Process:

* The NYC 311 calls were restricted by location type of violation to initially include: restaurant, residential, family, and private house. However, further inspection into the 311 call files revealed that other types of location should be included, namely, apartment and residence. As for the restaurant violation files, the following were added for filtration: bars, clubs, bakery, deli, cafeteria, catering, food cart, and soup kitchen. The new approach is meant to broaden the selection process and improve the accuracy of the results.

* The location type data had formatting issues such as: the same word written in lower and upper cases and the same location mentioned more than once in different formats and groups i.e. residential and residential/house. There are also N/As and mixed use housing (residential and none). All these issues had to be identified and fixed by unifying the data. 

* Some columns were incorrectly labeled and therefore the columns were re-labeled based on the data it contained. This was observed in the following columns: `x_coordinate_state_plane`, `y_coordinate_state_plane`, `borough`, `longitude`, `latitude`, `location`, and `junk`. The details can be found in the hive code in appendix A.

* Some cities were mentioned multiple times as unique instances, in lower case and upper case. i.e. Astoria vs. ASTORIA. Some cities were described with more than one unique identifier i.e. BELLEROSE vs. BELLEROSE VILLAGE. Some cities were misspelled i.e. CEDARHURST vs. CEDERHURST. One field was missing data.

* The restaurant violations and housing violations files were restricted to year 2016 given that the NYC 311 calls file covered only the year 2016.

* `created_date` was selected as a variable from the NYC 311 calls and the `inspection_date` in both restaurant and housing violations files were chosen to match that date. At a later check, the "Inspection Date" was replaced by `record_date` as it preceded inspection and better matched "Created Date".

* The column `month` was created for all tables except population, by substrating the first two characters of the corresponding date column.

## Data Merging Process

The initial step in the data merging process centered on the creation of multiple views of each database filtered and grouped by relevant variables. The relevant variables were determined using the knowledge gained from the data understanding and data cleaning processes. A total of 8 views were created during this step (4 for merging by zip code and month, 4 for merging by zip code only).

### Merging by zip code and month

First, the data was explored to identify if there were any differences by month in terms of calls and violations. To accomplish this, 4 views were created of data aggregated by zip code and month as follows:

#### Creation Of Aggregated Data Views

* View 1 labeled `restaurantcallsbyzipmonth` referenced the nyc311callscleaned database to filter by `location_type` where it contained the words: "restaurant", "soup", "catering", "food", and "cafeteria". The data was then grouped by zip code and month. The resulting variable is called `restaurant_calls` and is defined as the number of 311 calls related to restaurants for each zip code and month for the year 2016.

* View 2 labeled `housingcallsbyzipmonth` referenced the nyc311callscleaned database to filter by `location_type` where it contained the words: "residential", "family", "private house", "apartment", and "residence". The data was then grouped by zip code and month. The resulting variable is called `housing_calls` and is defined as the number of 311 calls related to housing for each zip code and month for the year 2016.

* View 3 labeled `restaurantsbyzipmonth` referenced the nycrestaurantscleaned database to group by zip code and month. The resulting variable is called `restaurant_violations` and is defined as the number of inspections that resulted in violations related to restaurants for each zip code and month for the year 2016.

* View 4 labeled `housingbyzipmonth` referenced the housingcleaned database to group by zip code and month. The resulting variable is called `housing_violations` and is defined as the number of inspections that resulted in violations related to housing for each zip code and month for the year 2016.

#### Data Merging Step

Following the creation of the four views in the step above, the next step consisted of merging the views. The data merging step included the creation of a new database labeled `allbyzipmonth` which joined the four views created in the previous step with the population of New York City created in the cleaning step (`nycpopbyzip`). The merge process joined each of the four views by zip code and month. The population was duplicated in all months for the same zipcode (but this didn't represent a problem for our objective).

### Merging by zip code only

After visualizing the data by month, it was decided to explore the overall behavior of housing calls, violations and population for all of 2016. A similar process was followed as in the data grouped by zip code and month and is presented as follows:

#### Creation Of Aggregated Data Views

* View 1 labeled `restaurantcallsbyzip` referenced the nyc311callscleaned database to filter by `location_type` where it contained the words "restaurant", "soup", "catering", "food", and "cafeteria". The data was then grouped by zip code. The resulting variable is called `restaurant_calls` and is defined as the number of 311 calls related to restaurants for each zip code in the year 2016.

* View 2 labeled `housingcallsbyzip` referenced the nyc311callscleaned database to filter by `location_type` where it contained the words "residential", "family", "private house", "apartment", and "residence". The data was then grouped by zip code. The resulting variable is called `housing_calls` and is defined as the number of 311 calls related to housing for each zip code in the year 2016.

* View 3 labeled `restaurantsbyzip` referenced the nycrestaurantscleaned database to group by zip code. The resulting variable is called `restaurant_violations` and is defined as the number of inspections that resulted in violations related to restaurants for each zip code in the year 2016.

* View 4 labeled `housingbyzip` referenced the housingcleaned database to group by zip code. The resulting variable is called `housing_violations` and is defined as the number of inspections that resulted in violations related to housing for each zip code in the year 2016.

#### Data Merging Step

Following the creation of the four views in the step above, the next step consisted of merging the views. The data merging step included the creation of a new database labeled `allbyzip` which joined the four views created in the previous step with the population of New York City created in the cleaning step (`nycpopbyzip`). The merge process joined each of the four views by zip code.

## Analysis

### Connect to database CADMS

This connects to the database (the code is commented because it takes considerable time to load). After the first time it is loaded into R, it is moved to a local `rds` file.
```{r connect, eval=FALSE}
# conn = dbConnect(drv,"jdbc:hive2://bigdata.stern.nyu.edu:10000/cadms;auth=noSasl","","")
```

### Bring views into R for visualizations

```{r get views, message=FALSE}
#allbyzipmonth <- dbGetQuery(conn, "select * from allbyzipmonth")
#saveRDS(allbyzipmonth, file="data/allbyzipmonth.rds")
#allbyzipmonth <- read.table("data/allbyzipmonth.txt", sep = "\t", header=T)
allbyzipmonth <- readRDS("data/allbyzipmonth.rds")
allbyzipmonth$month <- mapvalues(allbyzipmonth$month, 1:12, month.name) 

allbyzipmonth$month <- factor(allbyzipmonth$month, levels = month.name)
head(allbyzipmonth)
```

## Visualizations

### Housing

```{r houseBox1, fig.height=5, fig.width=15, retina=1, message=FALSE}
fluidRow(
  column(3,
         selectInput("variable", "Select Calls/Violations",
                     c("housing_calls", "housing_violations")))
)
renderPlot({
  var <- input$variable
  ylab <- ifelse(var == "housing_calls", "Number of 311 calls related to housing", "Number of housing violations")
  data <- allbyzipmonth[!(allbyzipmonth$month %in% c("November", "December")), ]
  data$month <- factor(data$month, levels=month.name[1:10])
  
  ggplot(data, aes(x=month, y=data[, var])) +
    labs(x="Month of the year", y=ylab) + 
    geom_boxplot(aes(fill=month)) +
    theme_tufte()
})
```

The above plots depict monthly housing violations and housing calls. The most interesting aspect of these plots is the relative increase in housing violations for October compared to the relatve decrease in housing call for October. Housing calls in October fell off dramatically compared to the previous months while housing violation increased dramatically. This might indicate that the housing calls are only for part of the month and are not complete for the month of October.

```{r houseVis1, fig.height=5, fig.width=15, retina=1, message=FALSE}
fluidRow(
  column(3,
         sliderInput("month", "Select month range", min=1, max=12, value=c(1,12)))
)
renderPlot({
  monthsSelected <- month.name[input$month[1]:input$month[2]]
  allbyzipmonth %>%
      filter(month %in% monthsSelected) %>%
      ggplot(aes(x=housing_calls, y=housing_violations)) +
      labs(x="Number of 311 calls related to housing", y="Number of housing violations") + 
      geom_point(aes(color=month)) +
      scale_x_continuous(limits = c(0, 3200)) +
      scale_y_continuous(limits = c(0, 2000)) +
      theme_tufte()
})
```

The number of housing violations plotted against the number of 311 calls per zip code behaves in a significantly linear fashion by month and in aggregate; as one would expect, an increase in the number of calls relates to an increase in housing violations. 

November and December do not have any reliable data points which could indicate that the city performs annual inspections or no inspections during this time, in lieu of inspections in response to 311 calls. Another reason could be that the calls were only recorded through mid October or the beginning of November. Nevertheless, October has consistently curious behavior over the course of this analysis in that it yields a low number of housing violations and a low number of 311 calls - this may be an error in the analysis process or a systemic factor of which the team does not have an understanding. 

### Restaurants

```{r resBox1, fig.height=5, fig.width=15, retina=1, message=FALSE}
fluidRow(
  column(3,
         selectInput("variable2", "Select Calls/Violations",
                     c("restaurant_calls", "restaurant_violations")))
)
renderPlot({
  var <- input$variable2
  ylab <- ifelse(var == "restaurant_calls", "Number of 311 calls related to restaurants", "Number of restaurant violations")
  data <- allbyzipmonth[!(allbyzipmonth$month %in% c("November", "December")), ]
  data$month <- factor(data$month, levels=month.name[1:10])
  
  ggplot(data, aes(x=month, y=data[, var])) +
    labs(x="Month of the year", y=ylab) + 
    geom_boxplot(aes(fill=month)) +
    theme_tufte()
})
```

The above plots depict monthly restaurant violations and restaurant calls. The most interesting aspect of these plots is the relative the relatve decrease in restaurant calls for October. Restaurant calls in October fell off dramatically compared to the previous months. This might indicate that the restaurant calls are only for part of the month and are not completefor the month of October.

```{r resVis, fig.height=5, fig.width=15, retina=1}
fluidRow(
  column(3,
         sliderInput("month2", "Select month range", min=1, max=12, value=c(1,12)))
)
renderPlot({
  monthsSelected <- month.name[input$month2[1]:input$month2[2]]
  allbyzipmonth %>%
      filter(month %in% monthsSelected) %>%
      ggplot(aes(x=restaurant_calls, y=restaurant_violations)) +
      labs(x="Number of 311 calls related to restaurants", y="Number of restaurant violations") + 
      geom_point(aes(color=month)) +
      scale_x_continuous(limits = c(0, 200)) +
      scale_y_continuous(limits = c(0, 600)) +
      theme_tufte()
})
```

The number of restaurant violations plotted against the number of 311 calls per zip code does not display a strong linear relationship  either in month or in aggregate. A separate view of the data by month does not deviate from this conclusion based on the aggregated months. One hypothesis that the group was testing was that environmental factors that motivate 311 calls may drive the number of restaurant violations but this does not appear to show within the results. 

### Population and housing

```{r pophous, fig.height=5, fig.width=15, retina=1}
fluidRow(
  column(3,
         sliderInput("month3", "Select month range", min=1, max=12, value=c(1,12))),
  column(3,
         selectInput("variable3", "Select calls or violations", 
                     c("housing_calls", "housing_violations")))
)
renderPlot({
  var <- input$variable3
  ylab <- ifelse(var == "housing_calls", "Number of 311 calls related to  housing", 
                 "Number of housing violations")
  ranged <- seq(input$month3[1], input$month3[2], by=1)
  monthsSelected <- month.name[ranged]
  allbyzipmonth %>%
      filter(month %in% monthsSelected & population > 2000) %>%
      ggplot(aes_string(x="population", y=var)) +
      labs(x="Population in 2010", y=ylab) + 
      geom_point(aes(color=month)) +
      scale_x_continuous(limits = c(0, 110000)) +
      scale_y_continuous(limits = c(0, 3500)) +
      theme_tufte()
})
```

The number of housing calls (and separately violations) plotted against the number of 311 calls per zip code shows some differences by months/seasons. Excluding October, which shows drastically different behavior than the other months and November and December which do not have any data, January-April tend to have less concentrated data sets while May-September are more concentrated. There are many more zip codes with higher instances of housing calls and violations in the winter/spring - perhaps due to seasonality and corresponding utility effects. This relationship appears to have potential for further exploration.

### Population and restaurants

```{r popres, fig.height=5, fig.width=15, retina=1}
fluidRow(
  column(3,
         sliderInput("month4", "Select month range", min=1, max=12, value=c(1,12))),
  column(3,
         selectInput("variable4", "Select calls or violations", 
                     c("restaurant_calls", "restaurant_violations")))
)
renderPlot({
  var <- input$variable4
  ylab <- ifelse(var == "restaurant_calls", "Number of 311 calls related to restaurant", 
                 "Number of restaurant violations")
  ranged <- seq(input$month4[1], input$month4[2], by=1)
  monthsSelected <- month.name[ranged]
  ylim <- ifelse(var == "restaurant_calls", 210, 600)
  allbyzipmonth %>%
      filter(month %in% monthsSelected & population > 2000) %>%
      ggplot(aes_string(x="population", y=var)) +
      labs(x="Population in 2010", y=ylab) + 
      geom_point(aes(color=month)) +
      scale_x_continuous(limits = c(0, 110000)) +
      scale_y_continuous(limits = c(0, ylim)) +
      theme_tufte()
})
```

Population and the number of restaurant calls shows the same banding of seasonality as in 'population and housing.' Winter/spring months tend to show looser groupings with higher maximums compared to summer/fall months with a global observation of maximums decreasing after Population 60,000.

Restaurant violations plotted against population do not show the same pattern but do have some slight differences in the maximum values with the winter/spring months being higher, to a less drastic degree than the number of calls.

### Analysis by zip code only

Brining additional views into R for visualization. These views are by zip code only and are merged by zip code and loaded below:

```{r load data }
# allbyzip <- dbGetQuery(conn, "select * from cadms.allbyzip")
# saveRDS(allbyzip, file="data/allbyzip.rds")
# allbyzip <- read.table('data/allbyzip.txt', sep="\t", header=T)
allbyzip <- readRDS("data/allbyzip.rds")
head(allbyzip)
```

## Visualizations by zip code only

Since violations do not occur in the last two months (November had one sum instance and December 0), another joined table was created- only by zip code because a significant amount of calls were not matching because they occurred in the last two months of the year.

### Restaurant calls and violations

An initial question of interest for the analysis: Is there a linear relationship between the number of 311 calls for restaurants and the number of violations by zip code?

```{r correlations}
cor(allbyzip$restaurant_calls, allbyzip$restaurant_violations)
```

The correlation between restaurant 311 calls and violations is `r round(cor(allbyzip$restaurant_calls, allbyzip$restaurant_violations), 2)`. It would be a good idea to go back to the location_type used to filter the 311 calls specific to restaurants and see if there were some missing categories that could be included as restaurants. Assuming there is no missing calls counted as 311 restaurant calls, it can be concluded that there is not a strong linear relationship between restaurant 311 calls and violations. Nevertheless, the null hypothesis can be tested to determine if the population's true linear relationship is zero:

```{r test correlation}
cor.test(allbyzip$restaurant_calls, allbyzip$restaurant_violations)
```

The p-value for the correlation test is less than 2.2e-16 so we reject the null hypothesis that the true linear correlation between 311 calls and violations for restaurants is zero.

### Housing calls and violations

The same question applies to the relationship between housing calls and violations:

```{r housing cor}
cor(allbyzip$housing_violations, allbyzip$housing_calls)
```

The correlation is `r round(cor(allbyzip$housing_violations, allbyzip$housing_calls), 2)`. In this case, there is a strong linear relationship between calls and violations for housing.

### Correlation matrix

```{r all cors}
cor(allbyzip[, -1])
```

Finally, a correlation matrix is produced to look for any other linear relationship between the variables. An additional correlation is the linear relationship between the population and housing calls (`r round(cor(allbyzip$population, allbyzip$housing_calls), 2)`).

### Housing

```{r houseVis2, fig.height=5, fig.width=15, retina=1}
allbyzip %>% 
    ggplot(aes(x=housing_calls, y=housing_violations)) +
    geom_point() +
    geom_smooth(method='loess') +
    labs(x="Number of 311 calls related to housing per zip code", 
         y="Number of housing violations per zip code") + 
    theme_tufte()
```

As with the truncated dataset from the earlier analysis, there is a strong linear relationship between the number of 311 calls by zip code plotted against the number of housing violations. The effects of heteroscedasticity are present and expected because the data is of count type. 

### Restaurants

```{r resVis2, fig.height=5, fig.width=15, retina=1}
allbyzip %>% 
    ggplot(aes(x=restaurant_calls, y=restaurant_violations)) +
    geom_point() +
    geom_smooth(method='loess') +
    labs(x="Number of 311 calls related to restaurants per zip code", 
         y="Number of restaurant violations per zip code") + 
    theme_tufte()
```

No change from the previous analysis - there is a very weak linear relationship between the number of 311 calls per zip code and the number of restaurant violations.

### Population and housing

```{r housepopVis, fig.height=5, fig.width=15, retina=1}
fluidRow(
  column(3, 
         selectInput("variable5", "Select calls or violations",
                     c("housing_calls", "housing_violations")))
  )

renderPlot({
    var= input$variable5
    ylab <- ifelse(var == "housing_calls", "Number of 311 calls related to housing",
                   "Number of housing violations")
    allbyzip %>% 
    ggplot(aes(x=population, y=allbyzip[, var])) +
    geom_point() +
    labs(x="Population in 2010", 
         y=ylab) + 
    theme_tufte()
})
```

Similar to other visualizations by zip code only, there was little change from earlier analysis. Housing violations vs population by zip code appear to have a more dispersed data set than housing calls vs. population by zip code and stay true to previous observations.

### Population and restaurants

```{r respopVis, fig.height=5, fig.width=15, retina=1}
fluidRow(
  column(3, 
         selectInput("variable6", "Select calls or violations",
                     c("restaurant_calls", "restaurant_violations")))
  )

renderPlot({
    var= input$variable6
    ylab <- ifelse(var == "restaurant_calls", "Number of 311 calls related to restaurants",
                   "Number of restaurant violations")
    allbyzip %>% 
    ggplot(aes(x=population, y=allbyzip[, var])) +
    geom_point() +
    labs(x="Population in 2010", 
         y=ylab) + 
    theme_tufte()
})
```

Restaurant calls and violations have a relationship with population, with restaurant violations being much more dispersed than calls. This may indicate a set of missing data or error in data transformation, as we do not expect to see such a stark difference in correlation between the two attributes. 

### Maps

#### Housing
```{r housemaps, message=FALSE, fig.show='hold', fig.align='center'}
data("zipcode")
names(zipcode)[1] <- "zipcode"
allcoordzip <- merge(zipcode, allbyzip)
rm(zipcode)
# get map
map<-get_map(location='New York City',maptype = "terrain", source='google')
op <- par(mfrow=c(1,2)) 
ggmap(map) + geom_point(
        aes(x=longitude, y=latitude, colour=housing_violations), 
        data=allcoordzip, alpha=1, na.rm = T)  + 
        scale_color_gradient(low="green", high="red")
ggmap(map) + geom_point(
        aes(x=longitude, y=latitude, colour=housing_calls), 
        data=allcoordzip, alpha=1, na.rm = T)  + 
        scale_color_gradient(low="green", high="red")
```

The heatmap indicates that most housing violations occur in the Bronx, Harlem, and Brooklyn. In the next heatmap iteration, it may be useful to change the ranges of heatmap color indications to have better visibility of housing violations below 5,000.

#### Restaurants
```{r resmaps, message=FALSE, fig.show='hold', fig.align='center'}
# get map
op <- par(mfrow=c(1,2)) 
map<-get_map(location='New York City',maptype = "terrain", source='google')
ggmap(map) + geom_point(
        aes(x=longitude, y=latitude, colour=restaurant_violations), 
        data=allcoordzip, alpha=1, na.rm = T)  + 
        scale_color_gradient(low="green", high="red")
ggmap(map) + geom_point(
        aes(x=longitude, y=latitude, colour=restaurant_calls), 
        data=allcoordzip, alpha=1, na.rm = T)  + 
        scale_color_gradient(low="green", high="red")
```

Lower Manhattan has the highest density of restaurant violations, followed distantly by portions of Brooklyn and Harlem.

##Conclusion

The above R markdown document is team CADMS' demonstration of the learning objectives set for the Big Data post-module period. The learning objectives included: how to interact with hive, how to understand and clean multiple databases, how to merge disparate data into one database, and finally how to analyze the data in order to draw conclusions and make correlations. To meet these objectives, Team CADMS created an interactive narrative of the step-by-step process followed since the post-module period began. The initial steps included accessing, understanding, and cleaning the data, followed by filtering the data to merge it into a single analyzable database. The final step was to conduct analysis and create visualizations to understand connections and correlations present in the data. Ultimatly, through team collaboration and persistant effort, Team CADMS learned a lot about each other and about Big Data!

##APPENDIX

###Data Dictionary

Here is the link to data dictionaty is here

[**CLICK HERE**](https://docs.google.com/spreadsheets/d/1JmR_Ltpbqzho_SWPS-0K1CfEyaVPVwluhBMAzfY7sNM/edit?usp=sharing)

###Cleaning Process SQL Code

This is the SQL code we used to clean the data.

```sql
-- Code to move tables to our own database
use cadms;

-- Move popbyzip2010 to cadms database
create table popbyzip2010 as select * from msba.popbyzip2010;

-- Move nyc311calls2016 to cadms database
create table nyc311calls2016 as select * from msba.nyc311calls2016;

-- Move housingviolations to cadms database
create table housingviolations as select * from msba.housingviolations;

-- Move nycrestaurants to cadms database
create table nycrestaurants as select * from msba.nycrestaurants;

-- Cleaned tables

-- New york population 2010
create or replace view nycpopbyzip as
    select substr(regexp_replace(zipcode, "[^\\d]", ""), 1, 5) as zipcode, population 
    from popbyzip2010
    where substr(regexp_replace(zipcode, "[^\\d]", ""), 1, 5) > 10000 and
        substr(regexp_replace(zipcode, "[^\\d]", ""), 1, 5) < 11697;

-- NYC 311 Calls cleaned and only (possible) relevant variables
create or replace view nyc311callscleaned as
    select substr(regexp_replace(incident_zip, "[^\\d]", ""), 1, 5) as zipcode,
    substr(created_date, 1, 2) as month, complaint_type, descriptor, 
    lower(location_type) as location_type,
    lower(x_coordinate_state_plane) as borough, 
    y_coordinate_state_plane as x_coordinate_state_plane,
    park_facility_name as y_coordinate_state_plane,
    location as longitude, longitude as latitude
    from nyc311calls2016
    where cast(substr(regexp_replace(incident_zip, "[^\\d]", ""), 1, 5) as int) > 10000 and 
    cast(substr(regexp_replace(incident_zip, "[^\\d]", ""), 1, 5) as int) <= 11697 and 
        lower(location_type) regexp '(.*soup.*|.*catering.*|.*food.*|.*cafeteria.*|.*restaurant.*|.*residential.*|.*family.*|private house|.*apartment.*|.*residence.*)'
        and lower(location_type) not in ('building (non-residential)');

-- Restaurant violations for 2016 only and NYC zip codes
create or replace view nycrestaurantscleaned as
    select substr(regexp_replace(zipcode, "[^\\d]", ""), 1, 5) as zipcode, dba as restaurant_name,
    substr(inspection_date, 1, 2) as month,
    lower(critical_flag) as iscritical, cuisine_description, grade, score, inspection_type,
    inspection_date
    from nycrestaurants
    where cast(substr(regexp_replace(zipcode, "[^\\d]", ""), 1, 5) as int) > 10000 and
          cast(substr(regexp_replace(zipcode, "[^\\d]", ""), 1, 5) as int) <= 11697 and
          inspection_date rlike '.*2016.*';

-- Housing violations for 2016 and NYC zip codes
create or replace view housingcleaned as
    select  substr(regexp_replace(zip, "[^\\d]", ""), 1, 5) as zipcode, class, currentstatus,
    substr(inspectiondate, 1, 2) as month
    from housingviolations
    where cast(substr(regexp_replace(zip, "[^\\d]", ""), 1, 5) as int) > 10000 and
          cast(substr(regexp_replace(zip, "[^\\d]", ""), 1, 5) as int) <= 11697 and
          inspectiondate rlike '.*2016.*';
```

###Dada Merging Process SQL Code

This is the SQL code we used to merge the data.

```sql
-- Aggregation experiments 

-- Restaurant calls
create or replace view restaurantcallsbyzipmonth as
    select count(*) as restaurant_calls, zipcode, month  
    from nyc311callscleaned
    where location_type regexp '(.*restaurant.*|.*soup.*|.*catering.*|.*food.*|.*cafeteria.*)'
    group by zipcode, month;
    
-- Housing calls 
create or replace view housingcallsbyzipmonth as
    select count(*) as housing_calls, zipcode, month
    from nyc311callscleaned
    where location_type regexp '(.*residential.*|.*family.*|private house|.*apartment.*|.*residence.*)' 
    group by zipcode, month;

-- nycrestaurants
create or replace view restaurantsbyzipmonth as
    select count(*) as restaurant_violations, zipcode, month
    from nycrestaurantscleaned
    group by zipcode, month;

-- housingviolations
create or replace view housingbyzipmonth as
    select count(*) as housing_violations, zipcode, month
    from housingcleaned
    group by zipcode, month;   
    
-- MERGE SECTION

-- First master file merged (I can add any other filtered views here to get number of
-- calls or violation by some filter variable like critical violations)

create or replace view allbyzipmonth as
    select A.zipcode as zipcode, cast(A.population as int) as population, B.month as month, 
    B.housing_violations as housing_violations, C.restaurant_violations as restaurant_violations,
    D.restaurant_calls as restaurant_calls, E.housing_calls as housing_calls
    from nycpopbyzip as A
    INNER JOIN (select * from housingbyzipmonth) as B on A.zipcode = B.zipcode
    INNER JOIN (select * from restaurantsbyzipmonth) as C on B.zipcode = C.zipcode and B.month = C.month
    INNER JOIN (select * from restaurantcallsbyzipmonth) as D on D.zipcode = C.zipcode and D.month = C.month
    INNER JOIN (select * from housingcallsbyzipmonth) as E on E.zipcode = D.zipcode and E.month = D.month;

-- SECOND STAGE (ONLY BY ZIPCODE)
-- reataurant calls
create or replace view restaurantcallsbyzip as
    select count(*) as restaurant_calls, zipcode  
    from nyc311callscleaned
    where location_type regexp '(.*restaurant.*|.*soup.*|.*catering.*|.*food.*|.*cafeteria.*)'
    group by zipcode;
    
-- housing calls
create or replace view housingcallsbyzip as
    select count(*) as housing_calls, zipcode
    from nyc311callscleaned
    where location_type regexp '(.*residential.*|.*family.*|private house|.*apartment.*|.*residence.*)' 
    group by zipcode;

-- nycrestaurants
create or replace view restaurantsbyzip as
    select count(*) as restaurant_violations, zipcode
    from nycrestaurantscleaned
    group by zipcode;

-- housingviolations
create or replace view housingbyzip as
    select count(*) as housing_violations, zipcode
    from housingcleaned
    group by zipcode;
        
-- MERGE SECTION
create or replace view allbyzip as
    select A.zipcode as zipcode, cast(A.population as int) as population,
    B.housing_violations as housing_violations, C.restaurant_violations as restaurant_violations,
    D.restaurant_calls as restaurant_calls, E.housing_calls as housing_calls
    from nycpopbyzip as A
    INNER JOIN (select * from housingbyzip) as B on A.zipcode = B.zipcode
    INNER JOIN (select * from restaurantsbyzip) as C on B.zipcode = C.zipcode
    INNER JOIN (select * from restaurantcallsbyzip) as D on D.zipcode = C.zipcode
    INNER JOIN (select * from housingcallsbyzip) as E on E.zipcode = D.zipcode;
```